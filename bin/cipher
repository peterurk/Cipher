#!/usr/bin/env php
<?php
require __DIR__.'/../vendor/autoload.php';

use peterurk\Cipher\Cipher;

$options = getopt('', ['encrypt::', 'decrypt::', 'key::', 'method::', 'hmac']);
$key = $options['key'] ?? getenv('CIPHER_KEY');
$method = $options['method'] ?? 'AES-256-CBC';
$useHmac = isset($options['hmac']);

if ($key === false || $key === '') {
    fwrite(STDERR, "A key is required via --key or CIPHER_KEY\n");
    exit(1);
}

$cipher = new Cipher($key, $method, $useHmac);

if (isset($options['encrypt'])) {
    $input = $options['encrypt'] !== false ? $options['encrypt'] : stream_get_contents(STDIN);
    echo $cipher->encrypt($input) . PHP_EOL;
    exit(0);
}

if (isset($options['decrypt'])) {
    $input = $options['decrypt'] !== false ? $options['decrypt'] : stream_get_contents(STDIN);
    echo $cipher->decrypt($input) . PHP_EOL;
    exit(0);
}

fwrite(STDERR, "Usage: cipher --encrypt <text>|--decrypt <text> [--key <key>] [--method <method>] [--hmac]\n");
exit(1);

